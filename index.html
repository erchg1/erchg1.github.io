<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Defibrillator Checklist</title>
    <!-- Chosen Palette: Pastel Blue -->
    <!-- Application Structure Plan: The application is a single-page, task-oriented checklist designed for efficiency. It uses collapsible accordions to categorize checks (General, Performance, Supplies), reducing cognitive load for medical staff. User inputs (name, date, check type) are grouped at the top. The core interaction involves simple status buttons. A live dashboard section provides immediate feedback with a 7-day trend chart and a real-time log of the latest checks, powered by Firestore. Clicking on a log entry with issues opens a modal for detailed problem review. This structure facilitates a quick, linear workflow while providing immediate historical context and drill-down capabilities. -->
    <!-- Visualization & Content Choices: Checklist Items -> Goal: Capture Status -> Viz/Presentation: Interactive HTML buttons -> Interaction: Click to set status, reveal notes field for "problem" states -> Justification: Faster and more touch-friendly than traditional inputs. Historical Data -> Goal: Analyze Trends & Review -> Viz/Presentation: Bar Chart (Chart.js) & HTML Table -> Interaction: Chart shows 7-day pass/fail summary. Table rows with problems are clickable, opening a JS-powered modal with details. -> Justification: Chart provides a quick visual overview of reliability. The interactive table allows for drilling down into specific issues without leaving the page. All visual elements, including the footer logo, use HTML/CSS to avoid external graphics. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: #EFF6FF; /* Pastel Blue */
        }
        .accordion-content { 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.3s ease-out; 
        }
        .accordion-header {
            background-color: #DBEAFE; /* Lighter Pastel Blue */
        }
        .accordion-header:hover {
            background-color: #BFDBFE;
        }
        .main-submit-btn {
            background-color: #60A5FA; /* Pastel Blue */
            color: white;
            font-weight: bold;
        }
        .main-submit-btn:hover {
            background-color: #3B82F6;
        }
        .status-btn {
            border-color: #93C5FD;
        }
        .status-btn.active-ok { 
            background-color: #A7F3D0; color: #047857; border-color: #047857; 
        }
        .status-btn.active-fail { 
            background-color: #FECACA; color: #B91C1C; border-color: #B91C1C; 
        }
        .status-btn.active-add { 
            background-color: #FED7AA; color: #C2410C; border-color: #C2410C;
        }
        .status-btn.active-no { 
            background-color: #E5E7EB; color: #4B5563; border-color: #4B5563;
        }
        .chart-container { 
            position: relative; 
            width: 100%; 
            max-width: 700px; 
            margin-left: auto; 
            margin-right: auto; 
            height: 300px; 
            max-height: 400px; 
        }
        @media (min-width: 768px) { 
            .chart-container { height: 350px; } 
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #60A5FA;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-container {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="text-blue-900">

    <div class="container mx-auto max-w-5xl p-4 sm:p-6 lg:p-8">

        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-blue-800">‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á Defibrillator Mindray BeneHeart D6</h1>
            <p id="current-datetime" class="text-blue-600 mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤...</p>
        </header>

        <main>
            <div class="bg-white p-6 rounded-xl shadow-lg space-y-6">
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="check-date" class="block text-lg font-semibold text-blue-800 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à</label>
                        <input type="date" id="check-date" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div>
                        <label for="check-time" class="block text-lg font-semibold text-blue-800 mb-2">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à</label>
                        <input type="time" id="check-time" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="checker-name" class="block text-lg font-semibold text-blue-800 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à</label>
                        <input type="text" id="checker-name" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>


                <div id="checklist-accordion" class="space-y-3">
                    
                    <div class="border border-blue-100 rounded-lg">
                        <button class="accordion-header w-full flex justify-between items-center p-4 text-left transition duration-200 rounded-t-lg">
                            <span class="text-xl font-semibold text-blue-800">1. ‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</span>
                            <span class="accordion-icon text-2xl font-bold text-blue-600 transform transition-transform duration-300">-</span>
                        </button>
                        <div class="accordion-content">
                            <div class="p-4 space-y-4">
                                <p class="text-blue-700">‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏†‡∏≤‡∏û‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏•‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
                                <div class="check-item p-3 border-b border-blue-50" data-item-id="cleanliness" data-item-name="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á">
                                    <div class="flex flex-col sm:flex-row justify-between sm:items-center">
                                        <p class="font-semibold mb-2 sm:mb-0">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</p>
                                        <div class="flex space-x-2 flex-shrink-0">
                                            <button class="status-btn px-4 py-1.5 border rounded-lg transition" data-status="‡∏õ‡∏Å‡∏ï‡∏¥">‚úîÔ∏è ‡∏õ‡∏Å‡∏ï‡∏¥</button>
                                            <button class="status-btn px-4 py-1.5 border rounded-lg transition" data-status="‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥">‚ùå ‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</button>
                                        </div>
                                    </div>
                                    <div class="problem-details hidden mt-3">
                                        <textarea placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤..." class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-red-400 focus:border-red-400"></textarea>
                                    </div>
                                </div>
                                <div class="check-item p-3 border-b border-blue-50" data-item-id="cables" data-item-name="‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Ç‡∏±‡πâ‡∏ß‡∏ï‡πà‡∏≠ (ECG/Adapter)">
                                    <div class="flex flex-col sm:flex-row justify-between sm:items-center">
                                        <p class="font-semibold mb-2 sm:mb-0">‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Ç‡∏±‡πâ‡∏ß‡∏ï‡πà‡∏≠ (ECG/Adapter)</p>
                                        <div class="flex space-x-2 flex-shrink-0">
                                            <button class="status-btn px-4 py-1.5 border rounded-lg transition" data-status="‡∏õ‡∏Å‡∏ï‡∏¥">‚úîÔ∏è ‡∏õ‡∏Å‡∏ï‡∏¥</button>
                                            <button class="status-btn px-4 py-1.5 border rounded-lg transition" data-status="‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥">‚ùå ‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</button>
                                        </div>
                                    </div>
                                     <div class="problem-details hidden mt-3">
                                        <textarea placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤..." class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-red-400 focus:border-red-400"></textarea>
                                    </div>
                                </div>
                                <div class="check-item p-3" data-item-id="paddles" data-item-name="‡∏™‡∏†‡∏≤‡∏û Paddle Electrode">
                                    <div class="flex flex-col sm:flex-row justify-between sm:items-center">
                                        <p class="font-semibold mb-2 sm:mb-0">‡∏™‡∏†‡∏≤‡∏û Paddle Electrode</p>
                                        <div class="flex space-x-2 flex-shrink-0">
                                            <button class="status-btn px-4 py-1.5 border rounded-lg transition" data-status="‡∏õ‡∏Å‡∏ï‡∏¥">‚úîÔ∏è ‡∏õ‡∏Å‡∏ï‡∏¥</button>
                                            <button class="status-btn px-4 py-1.5 border rounded-lg transition" data-status="‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥">‚ùå ‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</button>
                                        </div>
                                    </div>
                                     <div class="problem-details hidden mt-3">
                                        <textarea placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤..." class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-red-400 focus:border-red-400"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border border-blue-100 rounded-lg">
                        <button class="accordion-header w-full flex justify-between items-center p-4 text-left transition duration-200 rounded-t-lg">
                            <span class="text-xl font-semibold text-blue-800">2. ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û</span>
                             <span class="accordion-icon text-2xl font-bold text-blue-600 transform transition-transform duration-300">+</span>
                        </button>
                         <div class="accordion-content">
                            <div class="p-4 space-y-4">
                                <p class="text-blue-700">‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</p>
                                <div class="check-item p-3 border-b border-blue-50" data-item-id="battery" data-item-name="‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà (‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á 30 ‡∏ô‡∏≤‡∏ó‡∏µ)">
                                    <div class="flex flex-col sm:flex-row justify-between sm:items-center">
                                        <p class="font-semibold mb-2 sm:mb-0">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà (‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á 30 ‡∏ô‡∏≤‡∏ó‡∏µ)</p>
                                        <div class="flex space-x-2 flex-shrink-0">
                                            <button class="status-btn px-4 py-1.5 border rounded-lg transition" data-status="‡∏õ‡∏Å‡∏ï‡∏¥">‚úîÔ∏è ‡∏õ‡∏Å‡∏ï‡∏¥</button>
                                            <button class="status-btn px-4 py-1.5 border rounded-lg transition" data-status="‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥">‚ùå ‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</button>
                                        </div>
                                    </div>
                                    <div class="problem-details hidden mt-3">
                                        <textarea placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤..." class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-red-400 focus:border-red-400"></textarea>
                                    </div>
                                </div>
                                <div class="check-item p-3 border-b border-blue-50" data-item-id="power_button" data-item-name="‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô">
                                    <div class="flex flex-col sm:flex-row justify-between sm:items-center">
                                        <p class="font-semibold mb-2 sm:mb-0">‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô</p>
                                        <div class="flex space-x-2 flex-shrink-0">
                                            <button class="status-btn px-4 py-1.5 border rounded-lg transition" data-status="‡∏õ‡∏Å‡∏ï‡∏¥">‚úîÔ∏è ‡∏õ‡∏Å‡∏ï‡∏¥</button>
                                            <button class="status-btn px-4 py-1.5 border rounded-lg transition" data-status="‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥">‚ùå ‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</button>
                                        </div>
                                    </div>
                                     <div class="problem-details hidden mt-3">
                                        <textarea placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤..." class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-red-400 focus:border-red-400"></textarea>
                                    </div>
                                </div>
                                <div class="check-item p-3 border-b border-blue-50" data-item-id="discharge" data-item-name="‡∏ó‡∏î‡∏™‡∏≠‡∏ö Discharge ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á">
                                    <div class="flex flex-col sm:flex-row justify-between sm:items-center">
                                        <p class="font-semibold mb-2 sm:mb-0">‡∏ó‡∏î‡∏™‡∏≠‡∏ö Discharge ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                                        <div class="flex space-x-2 flex-shrink-0">
                                            <button class="status-btn px-4 py-1.5 border rounded-lg transition" data-status="‡∏õ‡∏Å‡∏ï‡∏¥">‚úîÔ∏è ‡∏õ‡∏Å‡∏ï‡∏¥</button>
                                            <button class="status-btn px-4 py-1.5 border rounded-lg transition" data-status="‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥">‚ùå ‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</button>
                                        </div>
                                    </div>
                                     <div class="problem-details hidden mt-3">
                                        <textarea placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤..." class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-red-400 focus:border-red-400"></textarea>
                                    </div>
                                </div>
                                <div class="check-item p-3" data-item-id="printer" data-item-name="‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå (Printer)">
                                    <div class="flex flex-col sm:flex-row justify-between sm:items-center">
                                        <p class="font-semibold mb-2 sm:mb-0">‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå (Printer)</p>
                                        <div class="flex space-x-2 flex-shrink-0">
                                            <button class="status-btn px-4 py-1.5 border rounded-lg transition" data-status="‡∏õ‡∏Å‡∏ï‡∏¥">‚úîÔ∏è ‡∏õ‡∏Å‡∏ï‡∏¥</button>
                                            <button class="status-btn px-4 py-1.5 border rounded-lg transition" data-status="‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥">‚ùå ‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</button>
                                        </div>
                                    </div>
                                     <div class="problem-details hidden mt-3">
                                        <textarea placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤..." class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-red-400 focus:border-red-400"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                     <div class="border border-blue-100 rounded-lg">
                        <button class="accordion-header w-full flex justify-between items-center p-4 text-left transition duration-200 rounded-t-lg">
                            <span class="text-xl font-semibold text-blue-800">3. ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</span>
                            <span class="accordion-icon text-2xl font-bold text-blue-600 transform transition-transform duration-300">+</span>
                        </button>
                        <div class="accordion-content">
                            <div class="p-4 space-y-4">
                                <p class="text-blue-700">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏†‡∏≤‡∏û‡∏î‡∏µ</p>
                                <div class="check-item p-3 border-b border-blue-50" data-item-id="paper" data-item-name="‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•">
                                    <div class="flex flex-col sm:flex-row justify-between sm:items-center">
                                        <p class="font-semibold mb-2 sm:mb-0">‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•</p>
                                        <div class="flex space-x-2 flex-shrink-0">
                                            <button class="status-btn px-4 py-1.5 border rounded-lg transition" data-status="‡∏°‡∏µ/‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ">üëç ‡∏°‡∏µ/‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ</button>
                                            <button class="status-btn px-4 py-1.5 border rounded-lg transition" data-status="‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°">üìã ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="check-item p-3 border-b border-blue-50" data-item-id="gel" data-item-name="‡πÄ‡∏à‡∏•‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡πÇ‡∏ó‡∏£‡∏î (Electrode Gel)">
                                    <div class="flex flex-col sm:flex-row justify-between sm:items-center">
                                        <p class="font-semibold mb-2 sm:mb-0">‡πÄ‡∏à‡∏•‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡πÇ‡∏ó‡∏£‡∏î (Electrode Gel)</p>
                                        <div class="flex space-x-2 flex-shrink-0">
                                            <button class="status-btn px-4 py-1.5 border rounded-lg transition" data-status="‡∏°‡∏µ/‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ">üëç ‡∏°‡∏µ/‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ</button>
                                            <button class="status-btn px-4 py-1.5 border rounded-lg transition" data-status="‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°">üìã ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="check-item p-3 border-b border-blue-50" data-item-id="pacemaker_paddles" data-item-name="External Pacemaker Paddle">
                                    <div class="flex flex-col sm:flex-row justify-between sm:items-center">
                                        <p class="font-semibold mb-2 sm:mb-0">External Pacemaker Paddle</p>
                                        <div class="flex space-x-2 flex-shrink-0">
                                            <button class="status-btn px-4 py-1.5 border rounded-lg transition" data-status="‡∏°‡∏µ/‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ">üëç ‡∏°‡∏µ/‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ</button>
                                            <button class="status-btn px-4 py-1.5 border rounded-lg transition" data-status="‡πÑ‡∏°‡πà‡∏°‡∏µ/‡∏ä‡∏≥‡∏£‡∏∏‡∏î">üö´ ‡πÑ‡∏°‡πà‡∏°‡∏µ/‡∏ä‡∏≥‡∏£‡∏∏‡∏î</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="check-item p-3" data-item-id="pediatric_pads" data-item-name="‡πÅ‡∏ú‡πà‡∏ô‡πÅ‡∏õ‡∏∞‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡πÇ‡∏ó‡∏£‡∏î‡πÄ‡∏î‡πá‡∏Å (Pediatric pads)">
                                    <div class="flex flex-col sm:flex-row justify-between sm:items-center">
                                        <p class="font-semibold mb-2 sm:mb-0">‡πÅ‡∏ú‡πà‡∏ô‡πÅ‡∏õ‡∏∞‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡πÇ‡∏ó‡∏£‡∏î‡πÄ‡∏î‡πá‡∏Å (Pediatric pads)</p>
                                        <div class="flex space-x-2 flex-shrink-0">
                                            <button class="status-btn px-4 py-1.5 border rounded-lg transition" data-status="‡∏°‡∏µ/‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ">üëç ‡∏°‡∏µ/‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ</button>
                                            <button class="status-btn px-4 py-1.5 border rounded-lg transition" data-status="‡πÑ‡∏°‡πà‡∏°‡∏µ/‡∏ä‡∏≥‡∏£‡∏∏‡∏î">üö´ ‡πÑ‡∏°‡πà‡∏°‡∏µ/‡∏ä‡∏≥‡∏£‡∏∏‡∏î</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="pt-6">
                    <button id="submit-btn" class="w-full main-submit-btn text-xl py-4 rounded-lg transition duration-300 shadow-lg">
                        ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à
                    </button>
                </div>
                 <div id="error-message" class="hidden text-center p-4 bg-red-100 text-red-800 rounded-lg mt-4">
                    <p class="font-bold">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!</p>
                    <p id="error-text">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</p>
                </div>
            </div>

            <div class="mt-12 bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-blue-800 mb-6 text-center">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h2>
                <div id="history-loading" class="text-center">
                     <div class="loader"></div>
                     <p class="text-blue-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à...</p>
                </div>
                <div id="history-content" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                    <div>
                        <h3 class="text-lg font-semibold text-center mb-4 text-blue-800">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à 7 ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤</h3>
                        <div class="chart-container">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                    <div>
                         <h3 class="text-lg font-semibold text-center mb-4 text-blue-800">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                         <div class="overflow-x-auto max-h-[30rem] border border-blue-100 rounded-lg">
                            <table class="w-full text-sm text-left text-blue-700">
                                <thead class="text-xs text-blue-800 uppercase bg-blue-100 sticky top-0">
                                    <tr>
                                        <th scope="col" class="px-4 py-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</th>
                                        <th scope="col" class="px-4 py-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                                        <th scope="col" class="px-4 py-3">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à</th>
                                        <th scope="col" class="px-4 py-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    </tr>
                                </thead>
                                <tbody id="history-log">
                                </tbody>
                            </table>
                         </div>
                    </div>
                </div>
                 <div id="history-empty" class="hidden text-center text-blue-600 py-8">
                    <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à</p>
                </div>
            </div>
        </main>
    </div>
    
    <footer class="mt-12 py-6">
        <div class="container mx-auto flex items-center justify-center gap-3">
            <div class="flex items-center justify-center h-10 w-10 border-2 border-blue-500 rounded-lg bg-blue-100 text-blue-700 font-bold text-sm tracking-tighter">
                ER
            </div>
            <span class="text-lg font-semibold text-blue-700">¬© ER-CHG1</span>
        </div>
    </footer>

    <div id="details-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-container bg-white w-full max-w-lg mx-auto rounded-xl shadow-2xl overflow-hidden transform scale-95">
            <div class="flex justify-between items-center p-4 border-b bg-blue-50">
                <h3 id="modal-title" class="text-xl font-bold text-blue-800">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤</h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div id="modal-content" class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
            </div>
        </div>
    </div>


<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    const checklistState = {};
    let statusChart = null;
    let db, auth, userId;

    const GOOGLE_SHEET_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw1a4ABt5DlwJGo_W3Ndfdsxg-AEmWL3jFFlwVNnk5S-CjSIijEGMy4bY2ucpOUpl6L/exec';

    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "...", authDomain: "...", projectId: "...", storageBucket: "...", messagingSenderId: "...", appId: "..." };
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-defib-app';

    document.addEventListener('DOMContentLoaded', () => {
        initializeUI();
        initializeAppAndAuth();
    });

    function initializeUI() {
        updateDateTime();
        setInterval(updateDateTime, 60000);
        
        const now = new Date();
        const year = now.getFullYear();
        const month = (now.getMonth() + 1).toString().padStart(2, '0');
        const day = now.getDate().toString().padStart(2, '0');
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        
        document.getElementById('check-date').value = `${year}-${month}-${day}`;
        document.getElementById('check-time').value = `${hours}:${minutes}`;

        setupAccordions();
        setupChecklistItems();
        setupSubmission();
        setupModal();
    }
    
    async function initializeAppAndAuth() {
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    loadHistory(); 
                } else {
                    try {
                         if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                         } else {
                            await signInAnonymously(auth);
                         }
                    } catch(authError) {
                        console.error("Authentication Error:", authError);
                        document.getElementById('history-loading').innerHTML = '<p class="text-red-500">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ</p>';
                    }
                }
            });

        } catch (e) {
            console.error("Firebase Initialization Error:", e);
            document.getElementById('history-loading').innerHTML = '<p class="text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
        }
    }
    
    function setupAccordions() {
        const accordionHeaders = document.querySelectorAll('.accordion-header');
        accordionHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const content = header.nextElementSibling;
                const icon = header.querySelector('.accordion-icon');
                const isOpen = content.style.maxHeight && content.style.maxHeight !== "0px";

                document.querySelectorAll('.accordion-content').forEach(c => c.style.maxHeight = null);
                document.querySelectorAll('.accordion-icon').forEach(i => i.textContent = '+');
                
                if (!isOpen) {
                    content.style.maxHeight = content.scrollHeight + "px";
                    icon.textContent = '-';
                }
            });
        });
        
        if (accordionHeaders.length > 0) {
            accordionHeaders[0].click();
        }
    }
    
    function setupChecklistItems() {
        document.querySelectorAll('.check-item').forEach(item => {
            const itemId = item.dataset.itemId;
            checklistState[itemId] = { status: null, notes: '' };

            const buttons = item.querySelectorAll('.status-btn');
            const problemDetails = item.querySelector('.problem-details');
            
            buttons.forEach(button => {
                button.addEventListener('click', () => {
                    const selectedStatus = button.dataset.status;
                    checklistState[itemId].status = selectedStatus;

                    buttons.forEach(btn => btn.classList.remove('active-ok', 'active-fail', 'active-add', 'active-no'));
                    
                    if (selectedStatus === '‡∏õ‡∏Å‡∏ï‡∏¥' || selectedStatus === '‡∏°‡∏µ/‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ') button.classList.add('active-ok');
                    else if (selectedStatus === '‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥') button.classList.add('active-fail');
                    else if (selectedStatus === '‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°') button.classList.add('active-add');
                    else button.classList.add('active-no');

                    if (problemDetails) {
                       problemDetails.classList.toggle('hidden', selectedStatus !== '‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥');
                    }
                });
            });

            const textarea = item.querySelector('textarea');
            if (textarea) {
                textarea.addEventListener('input', (e) => {
                    checklistState[itemId].notes = e.target.value.trim();
                });
            }
        });
    }

    function setupSubmission() {
        const submitBtn = document.getElementById('submit-btn');
        
        submitBtn.addEventListener('click', async () => {
            const formContainer = submitBtn.closest('.bg-white');
            const errorMessage = formContainer.querySelector('#error-message');
            const errorText = formContainer.querySelector('#error-text');

            const checkerName = document.getElementById('checker-name').value.trim();
            const checkDate = document.getElementById('check-date').value;
            const checkTime = document.getElementById('check-time').value;
            const allItemsChecked = Object.values(checklistState).every(item => item.status !== null);

            if (!checkerName || !checkDate || !checkTime || !allItemsChecked) {
                if (errorText) errorText.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
                if (errorMessage) {
                    errorMessage.classList.remove('hidden');
                    setTimeout(() => errorMessage.classList.add('hidden'), 4000);
                }
                return;
            }
            
            const userDateTime = new Date(`${checkDate}T${checkTime}`);
            const dayOfMonth = userDateTime.getDate();
            const dayOfWeek = userDateTime.getDay(); // 0 = Sunday

            let checkType = '‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô';
            if (dayOfMonth === 1) {
                checkType = '‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';
            } else if (dayOfWeek === 0) {
                checkType = '‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå';
            }
            
            const hasIssue = Object.values(checklistState).some(item => ['‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥', '‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°', '‡πÑ‡∏°‡πà‡∏°‡∏µ/‡∏ä‡∏≥‡∏£‡∏∏‡∏î'].includes(item.status));
            const overallStatus = hasIssue ? '‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤' : '‡∏ú‡πà‡∏≤‡∏ô';

            const finalDataForFirestore = {
                checkerName,
                checkTimestamp: Timestamp.fromDate(userDateTime),
                checkType,
                items: checklistState,
                overallStatus,
            };

            submitBtn.disabled = true;
            submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

            try {
                const collectionPath = `artifacts/${appId}/public/data/defibrillator_checks`;
                await addDoc(collection(db, collectionPath), finalDataForFirestore);
                
                await saveToGoogleSheet({
                    checkerName,
                    checkTimestamp: userDateTime.toISOString(),
                    checkType,
                    items: checklistState,
                    overallStatus,
                });

                formContainer.innerHTML = `<div class="text-center p-8"><p class="text-2xl font-bold text-green-600">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!</p><p class="text-green-500 mt-2">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ</p></div>`;

                setTimeout(() => window.location.reload(), 3000);

            } catch (e) {
                console.error("Submission Error: ", e);
                if(errorText) errorText.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
                if(errorMessage) errorMessage.classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.textContent = '‡∏™‡πà‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à';
            }
        });
    }

    async function saveToGoogleSheet(data) {
        if (!GOOGLE_SHEET_WEB_APP_URL) {
            console.warn('Google Sheets URL is not configured. Skipping sheet submission.');
            return; 
        }

        // Create a deep copy to transform for the sheet without affecting other processes
        const sheetData = JSON.parse(JSON.stringify(data));
        
        // Enhance the items object with full Thai names for better readability in the sheet
        const problemItemsForSheet = {};
        if (sheetData.overallStatus === '‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤') {
            for (const key in sheetData.items) {
                const item = sheetData.items[key];
                if (['‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥', '‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°', '‡πÑ‡∏°‡πà‡∏°‡∏µ/‡∏ä‡∏≥‡∏£‡∏∏‡∏î'].includes(item.status)) {
                    const itemElement = document.querySelector(`.check-item[data-item-id="${key}"]`);
                    const itemName = itemElement ? itemElement.dataset.itemName : key;
                    problemItemsForSheet[itemName] = { // Use the full name as the key
                        status: item.status,
                        notes: item.notes
                    };
                }
            }
        }
        sheetData.items = problemItemsForSheet; // Replace the original items with the enhanced version

        try {
            await fetch(GOOGLE_SHEET_WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(sheetData),
            });
            console.log('Successfully sent data to Google Sheet.');
        } catch (error) {
            console.error('Error sending data to Google Sheet:', error);
        }
    }
    
    function setupModal() {
        const modal = document.getElementById('details-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');

        const closeModal = () => {
            modal.classList.add('opacity-0');
            modal.querySelector('.modal-container').classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        };
        
        closeModalBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });
    }

    function loadHistory() {
        const collectionPath = `artifacts/${appId}/public/data/defibrillator_checks`;
        const q = query(collection(db, collectionPath));
        
        const historyLoading = document.getElementById('history-loading');
        const historyContent = document.getElementById('history-content');
        const historyEmpty = document.getElementById('history-empty');
        const logBody = document.getElementById('history-log');

        onSnapshot(q, (querySnapshot) => {
            historyLoading.classList.add('hidden');
            if (querySnapshot.empty) {
                historyEmpty.classList.remove('hidden');
                historyContent.classList.add('hidden');
                return;
            }
            
            historyEmpty.classList.add('hidden');
            historyContent.classList.remove('hidden');

            const checks = [];
            querySnapshot.forEach((doc) => {
                checks.push({ id: doc.id, ...doc.data() });
            });
            
            checks.sort((a, b) => b.checkTimestamp.seconds - a.checkTimestamp.seconds);

            renderHistoryLog(checks);
            renderStatusChart(checks);

        }, (error) => {
            console.error("Error fetching history: ", error);
            historyLoading.innerHTML = '<p class="text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>';
        });
        
        logBody.addEventListener('click', (e) => {
            const problemRow = e.target.closest('.problem-row');
            if (problemRow) {
                showProblemDetails(problemRow.dataset.details, problemRow.dataset.checkType);
            }
        });
    }
    
    function showProblemDetails(detailsJson, checkType) {
        const details = JSON.parse(detailsJson);
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');

        modalTitle.textContent = `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à${checkType})`;
        
        let html = '<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤</p>';
        if (details && Object.keys(details).length > 0) {
             html = Object.entries(details).map(([item, note]) => `
                <div class="pb-2 mb-2 border-b border-blue-100">
                   <p class="font-semibold text-blue-800">${item}</p>
                   <p class="text-gray-600 pl-2">${note || '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'}</p>
                </div>
             `).join('');
        }
        modalContent.innerHTML = html;

        const modal = document.getElementById('details-modal');
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            modal.querySelector('.modal-container').classList.remove('scale-95');
        }, 10);
    }

    function renderHistoryLog(checks) {
        const logBody = document.getElementById('history-log');
        logBody.innerHTML = '';

        checks.slice(0, 20).forEach(check => {
            const dateTime = new Date(check.checkTimestamp.seconds * 1000).toLocaleString('th-TH', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit', hour12: false
            }).replace(',', '');
            
            let rowClass = 'bg-white border-b';
            let statusClass = 'bg-green-100 text-green-800';
            let detailsAttr = '';
            const checkType = check.checkType || '‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô';
            
            if (check.overallStatus === '‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤') {
                statusClass = 'bg-red-100 text-red-800';
                rowClass += ' problem-row cursor-pointer hover:bg-blue-50';
                
                const problemNotes = {};
                for (const key in check.items) {
                    const item = check.items[key];
                    if (['‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥', '‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°', '‡πÑ‡∏°‡πà‡∏°‡∏µ/‡∏ä‡∏≥‡∏£‡∏∏‡∏î'].includes(item.status)) {
                         const itemElement = document.querySelector(`.check-item[data-item-id="${key}"]`);
                         const itemName = itemElement ? itemElement.dataset.itemName : key;
                         problemNotes[itemName] = `${item.status}${item.notes ? `: ${item.notes}` : ''}`;
                    }
                }
                detailsAttr = `data-details='${JSON.stringify(problemNotes)}' data-check-type='${checkType}'`;
            }
            
            const row = `
                <tr class="${rowClass}" ${detailsAttr}>
                    <td class="px-4 py-3">${dateTime} ‡∏ô.</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">${checkType}</span></td>
                    <td class="px-4 py-3 font-medium text-blue-900 whitespace-nowrap">${check.checkerName}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 ${statusClass} rounded-full text-xs font-medium">${check.overallStatus}</span>
                    </td>
                </tr>
            `;
            logBody.innerHTML += row;
        });
    }

    function renderStatusChart(checks) {
        const labels = [];
        const passedData = Array(7).fill(0);
        const failedData = Array(7).fill(0);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        for (let i = 6; i >= 0; i--) {
            const d = new Date(today);
            d.setDate(d.getDate() - i);
            labels.push(d.toLocaleDateString('th-TH', { weekday: 'short' }).replace('.', ''));
        }

        checks.forEach(check => {
            const checkDate = new Date(check.checkTimestamp.seconds * 1000);
            checkDate.setHours(0,0,0,0);
            const diffTime = today - checkDate;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays >= 0 && diffDays < 7) {
                const index = 6 - diffDays;
                if (check.overallStatus === '‡∏ú‡πà‡∏≤‡∏ô') passedData[index]++;
                else failedData[index]++;
            }
        });

        const ctx = document.getElementById('statusChart').getContext('2d');
        if (statusChart) statusChart.destroy();
        
        statusChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '‡∏ú‡πà‡∏≤‡∏ô',
                    data: passedData,
                    backgroundColor: 'rgba(56, 189, 248, 0.7)',
                    borderColor: 'rgba(14, 116, 144, 1)',
                    borderWidth: 1
                }, {
                    label: '‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤',
                    data: failedData,
                    backgroundColor: 'rgba(252, 165, 165, 0.7)',
                    borderColor: 'rgba(220, 38, 38, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, ticks: { stepSize: 1 }}},
                plugins: {
                    title: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (context) => `${context.dataset.label || ''}: ${context.parsed.y} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`
                        }
                    }
                }
            }
        });
    }

    function updateDateTime() {
        const now = new Date();
        const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long', hour: '2-digit', minute: '2-digit' };
        document.getElementById('current-datetime').textContent = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${now.toLocaleDateString('th-TH', options)}`;
    }

</script>

</body>
</html>
